## Назначение проекта ##
Данный проект предназначен для равертывания VPN сервера и доступа клиентов в локальную, всемерную сеть средствами [OpenVPN](https://openvpn.net/) сервера.

## Условные обозначения ##
- **РК** - резервное копирование
- **ЦС** - центр сертификации
- **ОС** - операционная система
***
### Используемые компоненты ###
Скриты для автоматического равертывания используют оболочку [BASH](https://ru.wikipedia.org/wiki/Bash)

- **Для проекта использованы следующие компоненты:**
1. **ОС:** ***[Ubuntu Linux](https://ubuntu.com/)***
2. **Облачный провайдер:** ***[Google Cloud](https://cloud.google.com/)***
3. **Используемые пакеты приложений:**
 - [OpenVPN](https://openvpn.net/)
 - [Easy-RSA](https://easy-rsa.readthedocs.io/en/latest/)
 - [Expect](https://core.tcl-lang.org/expect/index)
 - [prometheus](https://prometheus.io/)
 - [prometheus-node-exporter](https://github.com/prometheus/node_exporter)
 - [rclone](https://rclone.org/)
---

## Запуск и работа скрипта ##

**Список файлов:**
 - **vpn.sh**  - скрипт настройки VPN сервера
 - **vpnclient.sh**  - скрипт генерации конфигурации клиента 
 - **base.conf** - образец настроек клиента
 - **before.rules** - образец настроек фаерволла
 - **server.conf** - образец настроек сервера OpenVPN
 - **make.sh** - основной скрипт, создание ВМ, бэкапов, сервисов
 - **make_config.sh** - скрипт подготовки клиетской конфигурации OpenVPN

Система развертывания организована следующим образом:
1. При запуске скрипта **make.sh** инициируются переменные - в частности расположение конфигурации и сертификатов на системе администратора (Linux система).
2. Проверится наличие утилиты **gcloud**, в случае отсутствия устанавливается, предлагает инструкцию по настройке авторизациии в Google Cloud и прекращает работу пока не будет выполнена настройка доступа к Google Cloud средствами **gcloud init**;
3. В случае выполненной авторизации в Google Cloud проверяется наличие каталога для конфигурации и сертификатов на системе администратора и выполняется его очистка для копирования новой конфигурации
4. После успешного выполнения предыдущих проверок выполняется настройка файрволла на стороне Google Cloud для публичного доступа к **Prometheus** и **OpenVPN**
***
5. Далее средствами утилиты **gcloud** создаются виртуальные машины с последующей настройкой программного обеспечения
6. Создается **PKI-Server**, выполняется обновление ОС, установка необходимых пакетов и настройка центра сертификации, автоматически генерируется парольная фраза к паре открытого и закрытого ключа ЦС.
 - Парольная фраза будет сохранена в файле **ca.txt**,  с последующим копирование данного файла на систему администратора в каталог конфигураций
 > при необходимости переменную **confdir** можно переопределить в скрипте **make.sh**
 - Далее будет сконфигурированы сервисы для резервного копирования - **backup.service** и **backup.timer**. Их задача выполнить резервное копирование в указанное время локально и перенести РК в облачное хранилище
 - Облачное хранилище так же настраивается автоматически и использует ПО **rclone**
 ### Примечание
 В скрипте make.sh необходимо изменить следующе параметры для выполнения резервного копирования в облако Google, Dropbox, Yandex Disk и т.д. :
> - [cloud]
> - type = [***тип облачного хранилища***](https://rclone.org/docs/)
> - user = ***логин***
> - pass = ***пароль***
***
7. Следующим этапом создается и настраивается **OpenVPN** сервер.
 - На **OpenVPN-Server** выполняется обновление ОС, установка необходимых пакетов и настройка ПО
 - Генерируются запросы на сертификат для **OpenVPN** сервера и переносятся на систему администратора в каталог конфигураций, далее данный запрос на сертификат переносится на **PKI-Server**
 - Выполняется подпись запроса на сертификат **OpenVPN** сервера сервером **ЦС** и перенос подписанного сертификата на сервер **OpenVPN**
 - Выполняется настройка **OpenVPN** сервера средствами скрипта **vpn.sh** - настройка файрволла, разрешение перенаправления пакетов и т.д., **vpn.sh** - будет скачан с git репозитария
 - Далее будет сконфигурированы сервисы для резервного копирования - **backup.service** и **backup.timer**. Их задача выполнить резервное копирование в указанное время локально и перенести РК в облачное хранилище
 - Облачное хранилище так же настраивается автоматически и использует ПО **rclone**.
 - Выполняется перезагрузка сервера
***
8. Следующим этапом создается и настраивается **Prometheus-Server** сервер
 - На **Prometheus-Server** выполняется обновление ОС, установка необходимых пакетов и настройка ПО
 - Выполняется настройка **Prometheus** сервера ***/etc/prometheus/prometheus.yml***
 - Выполняется настройка **Prometheus Alert Manager**-а ***/etc/prometheus/alertmanager.yml***, ***/etc/prometheus/alert.rules.yml***
 - Выполняется перезапуск сервисов для применения конфигурации **Prometheus** и **Prometheus Alert Manager**-а
9. Выполняется поиск локальных ip адресов виртуальных машин и вносятся в **hosts** файлы
***
10. ### Генерация клиентской конфигурации **OpenVPN**
 - Для генерации конфигурации клиента используется скрипт **vpnclient.sh**
 ### Примечание
 > при запуске **vpnclient.sh** обязательно указать 1-й аргумент - ***имя клиента***
 - **vpnclient.sh** создает временный скрипт **tempclient.sh** и подменяет имя клиента указанного в аргументе для скрипта **vpnclient.sh**
 - выполняется подключение к серверу **OpenVPN**
 - далее скрипт генерирует файл запроса на сертификат
 - файл запроса переносится на **PKI-Server** и подписывается
 - сертификаты и ключ клиента переносятся на **OpenVPN** сервер
 - далее **make_config.sh** генерирует конфигурацию OpenVPN клиента в виде файла - **client.ovpn** с внесением всех ключей и сертификатов
 - далле файл переносится в каталог конфигураций на системе администратора

## Планы по развитию проекта ##
1. Настроить автаризацию для Prometheus
2. Автоматизация доставки конфигурации клиента OpenVPN по каналам telegram и электронной почты
3. Автоматизация отзыва сертификат клиента
